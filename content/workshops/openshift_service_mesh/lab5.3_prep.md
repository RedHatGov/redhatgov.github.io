---
title: Security - Auth Policy Prep
workshops: openshift_service_mesh
workshop_weight: 53
layout: lab
---

# Single Sign-On
Login, registration, and role-based authorization is handled via Red Hat SSO (aka Keycloak).
SSO is included as part of OpenShift or any middleware product subscription you have from Red Hat - woot!

## Installation
Because the service mesh will leverage SSO to authenticate users and generate JWT we need to install it. You will install it via Operator into your namespace.

### Customize the Resources
Check out the .yaml files here and customize for this workshop cluster's domain, and your user project. Note that we have relaxed SSO security settings for the workshop and SSO config should be tightened up for production (e.g. things like CORS and the use of wildcards).

### Create an Instance of SSO / Configuration
You can do this CLI or web console. If using web console just use the + button at the top then drag'n'drop the file from the steps below.

<blockquote>
<i class="fa fa-terminal"></i> We create a Keycloak instance using a Kubernetes resource:
</blockquote>

```
oc apply -f ./istio-configuration/sso-keycloak.yaml
```

```
oc patch cm/keycloak-probes -p '{"data":{"liveness_probe.sh":"#!/bin/bash\necho pass\n","readiness_probe.sh":"#!/bin/bash\necho pass\n"}}'
```

<blockquote>
<i class="fa fa-terminal"></i> Watch the pods for keycloak-0 to become READY 1/1:
</blockquote>

```
oc get pods keycloak-0 -w
```

```
NAME                                       READY   STATUS      RESTARTS   AGE
keycloak-0                                 0/1     Pending       0          0s
keycloak-0                                 0/1     Init:0/1      0          0s
keycloak-0                                 0/1     Init:0/1      0          3s
keycloak-0                                 0/1     Init:0/1      0          4s
keycloak-0                                 0/1     PodInitializing   0          9s
keycloak-0                                 1/1     Running           0          10s
```

<br>

<blockquote>
<i class="fa fa-terminal"></i> We configure via Kubernetes resources to create the realm + roles + clients & users as follows:
</blockquote>

```
sed "s|http://istio-ingressgateway-istio-system.apps.cluster.domain.com|$GATEWAY_URL|" ./istio-configuration/sso-realm.yaml | oc create -f -
```

```
oc apply -f ./istio-configuration/sso-user1.yaml
```

```
oc apply -f ./istio-configuration/sso-user2.yaml
```

### Login to the SSO Admin Console
<blockquote>
<i class="fa fa-terminal"></i>
Open the SSO console.  Retrieve the endpoint:
</blockquote>

```
SSO_CONSOLE=$(oc get route keycloak --template='https://{{.spec.host}}')
echo $SSO_CONSOLE
```

<p>
<i class="fa fa-info-circle"></i>
Even after it's running keycloak will continue to initialize for a bit. If you are watching the pod logs you should see a line saying " Admin console listening on" which indicates it's ready for you to login.
</p>

<br>
Your admin username is `admin` and the password is autogenerated. These are in a secret called: `credential-workshop-keycloak`

<blockquote>
Choose one of the options below to find your password:
</blockquote>

{{< panel_group >}}
{{% panel "You can get the secret from the OpenShift web console (click to expand)" %}}

<blockquote>
<i class="fa fa-desktop"></i> In the Developer View, click to expand the "Advanced" dropdown
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Click "Project Details"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Scroll down a bit and click on "Secrets" from the Inventory panel
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Find the secret named "credential-workshop-keycloak" and click on it
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Scroll to the bottom and click the "Reveal Values" then copy the password
</blockquote>

{{% /panel %}}

{{% panel "Or you can get the secret with the CLI (click to expand)" %}}

<blockquote>
<i class="fa fa-terminal"></i>
Run the following to print the secret out:
</blockquote>

```
oc get secret/credential-workshop-keycloak -o yaml
```

You'll see something like:
```
apiVersion: v1
data:
  ADMIN_PASSWORD: SVZuM0pZQmNCeGl3bGc9PQ==
  ADMIN_USERNAME: YWRtaW4=
kind: Secret
```

<blockquote>
From your output, copy the characters you see next to "ADMIN_PASSWORD: "
</blockquote>

<blockquote>
<i class="fa fa-terminal"></i>
Decode the characters by running (replace your copy):
</blockquote>

```
echo <PASTE_YOUR_DATA_HERE> | base64 -D
```

<blockquote>
<i class="fa fa-terminal"></i>
Copy the password decoded
</blockquote>

{{% /panel %}}
{{< /panel_group >}}

<blockquote>
<i class="fa fa-desktop"></i> Goto the SSO web console and login as "admin" with the password you copied
</blockquote>

<br>


### Editing Config with the SSO Web Console
<blockquote>
<i class="fa fa-desktop"></i> Now that you're logged in, click on "Users" and "View all users"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Select the "demo" user and goto "Credentials"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Set or Reset the password to "demo" (make sure the Temporary check box is set to "off")
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Repeat for the user "theterminator" and set the password to "illbeback"
</blockquote>

<br>

### Now we will create some roles for our users in the SSO Web Console


<blockquote>
<i class="fa fa-desktop"></i> With the user "theterminator" still selected click "Role Mappings"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Click on the "cool-kids" role to highlight it. And click the "Add selected" button to give the role.
</blockquote>

{{< panel_group >}}
{{% panel "If you don't see cool-kids in the list (click to expand)" %}}

<blockquote>
<i class="fa fa-desktop"></i> On the left side bar click on "Roles" and "View all roles"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> On the right side of the screen click on "Add Role"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Type in "cool-kids" and a description, then click "Save"
</blockquote>

<blockquote>
<i class="fa fa-desktop"></i> Now go back to "Users" choose "theterminator" and you should be able to do the realm role mapping
</blockquote>

{{% /panel %}}
{{< /panel_group >}}

<br>

## Tell the APP UI to use this SSO service
We had been faking login earlier to test our app without requiring SSO. Now let's get rid of that and redeploy the app_ui service.

<blockquote>
<i class="fa fa-terminal"></i>
Type the following in the CLI:
</blockquote>

```
oc create route reencrypt keycloak-alt --service=keycloak 
```
```
SSO_SVC=$(oc get route keycloak-alt --template='{{.spec.host}}')
oc set env dc/app-ui FAKE_USER=false SSO_SVC_HOST=$SSO_SVC
```

<br/>

## Access Info / API documentation
- Admin can login at: https://keycloak-userX.apps.YOURCLUSTER.COM/
- Users will login at: https://keycloak-userX.apps.YOURCLUSTER.COM/auth/realms/microservices/account
- To understand more about keycloak check out the resources below:
  - [Official Docs][1]
  - [Upstream Docs][2]
  - [Blog Example][3]

<br/>

[1]: https://access.redhat.com/documentation/en-us/red_hat_single_sign-on/7.3/html-single/red_hat_single_sign-on_for_openshift/
[2]: https://www.keycloak.org/documentation.html
[3]: https://developers.redhat.com/blog/2020/01/29/api-login-and-jwt-token-generation-using-keycloak/
