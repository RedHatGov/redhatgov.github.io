---
title: Lab 3 - Using Windup
workshops: jboss_windup
workshop_weight: 30
layout: lab
---

# Using Windup

Use Windup to migrate a sample project

## Prerequisites

Successful completion of the previous lab

## Step 1. Execute Windup Against Source Code

The source code for this lab is provided in the lab2 directory:
~~~~
cd lab2
~~~~

1. Review the project and note that it has WebLogic-specific features throughout.

2. Run Windup against this source to help with the migration:

~~~~
windup --input gpte-windup-sample --output windup_output --packages com.acme,org.apache --source weblogic --target eap --sourceMode
~~~~

3. Observe the use of the `sourceMode` option at the end of the command.

    * This informs Windup that you are working with source code instead of compiled code.

4. Open the Windup Application Report.

{{% alert info %}}
In the following sections, you review the Overview report links and address project migration issues.
{{% /alert %}}

## Step 2. Migrate jee-example-app

The top of the overview page shows a total of 25 story points. The first section does not show any story points for the `pom.xml` file.

1. Scroll to the `jee-example-app` section that shows four story points.

2. Click the link for the `LogEventTopic-jms.xml` file.

3. Go to the JMS configuration documentation provided by the link.

    * The documentation instructs you to add configuration for the queue.

4. Add configuration for `jms/LogEventQueue`:

    1. Go to `$JBOSS_HOME/standalone/configuration`.

    2. Copy `standalone-full.xml` to a new file named `standalone-full-windup.xml`.

    3. Open `standalone-full-windup.xml` in a text editor.

    4. Search for `jms-destinations`.

    5. Copy the format of the `ExpiryQueue` destination to create a destination for `LogEventQueue`.  The JMS destinations configuration should look like the following:
~~~~
                <jms-destinations>
                   <jms-queue name="ExpiryQueue">
                      <entry name="java:/jms/queue/ExpiryQueue"/>
                   </jms-queue>
                   <jms-queue name="DLQ">
                      <entry name="java:/jms/queue/DLQ"/>
                   </jms-queue>
                   <jms-queue name="LogEventQueue">
                      <entry name="java:/jms/LogEventQueue"/>
                   </jms-queue>
               </jms-destinations>
~~~~

    6. Delete the original `LogEventTopic-jms.xml` file.

    7. Return to Overview in the Windup report.

5. Click the link for `weblogic-application.xml`.
{{% alert info %}}
For the sake of brevity, the WebLifeCycleListener class and the applicationâ€™s security aspects are not migrated.
{{% /alert %}}

6. Delete the `com.acme.anvil.listener` package.

7. Delete the `weblogic-application.xml` file.

8. Return to Overview in the Windup report.

## Step 3. Migrate `jee-example-services`

1. Go to the next item: `weblobic-ejb-jar.xml`

2. Add the missing `jboss-ejb3.xml` file to the project:

    1. Use the Save As link on the descriptor Generated by Windup and save the file to `jee-example-services/src/main/resources/META-INF/jboss-ejb3.xml`.

    2. Open and review the contents of this file.

    3. Remove `ejb-jar.xml`.

        * You are converting from Enterprise Java Beans (EJB) 2.1 to EJB 3, so this file is no longer needed.

    4. Return to Overview in the Windup report.

3. Click the link for `AnvilWebLifecycleListener` and then return to Overview in the Windup report.

    * This class is not required by the application and has already been removed.

4. Click the link for `AnvilWebStartupListener.java` and then return to Overview in the Windup report.

    * This class is not required by the application and has already been removed.

5. Click the link for `LogEventPublisher`.

    1. Review this class and notice that it simply adds a message to a queue.

         * You need to replace the WebLogic code with the JBoss equivalent.

    2. Edit code in `jee-example-services/src/main/java/com/acme/anvil/service/jms/LogEventPublisher.java` to the following:
~~~~
        package com.acme.anvil.service.jms;

        import java.util.Properties;

        import javax.jms.JMSException;
        import javax.jms.ObjectMessage;
        import javax.jms.Queue;
        import javax.jms.QueueConnection;
        import javax.jms.QueueConnectionFactory;
        import javax.jms.QueueSender;
        import javax.jms.QueueSession;
        import javax.jms.TopicPublisher;
        import javax.jms.TopicSession;
        import javax.naming.Context;
        import javax.naming.InitialContext;
        import javax.naming.NamingException;

        import org.apache.log4j.Logger;
        import com.acme.anvil.vo.LogEvent;

        public class LogEventPublisher {

            private static final Logger LOG = Logger.getLogger(LogEventPublisher.class);
            private static final String QUEUE_JNDI_NAME = "jms/LogEventQueue";
            private static final String QUEUE_FACTORY_JNDI_NAME = "/ConnectionFactory";

            public static void publishLogEvent(LogEvent log) {

                    try {
                        Context ic = getContext();
                        QueueSession session = getQueueSession(ic);
                        Queue queue = getQueue(ic);
                        QueueSender sender = session.createSender(queue);
                        ObjectMessage logMsg = session.createObjectMessage(log);

                        sender.send(logMsg);
                    } catch (JMSException e) {
                        LOG.error("Exception sending message.", e);
                    } catch (NamingException e) {
                        LOG.error("Exception looking up required resource.", e);
                    }
            }

            private static Context getContext() throws NamingException {
                return new InitialContext();
            }

            private static Queue getQueue(Context context) throws NamingException {
                return (Queue) context.lookup(QUEUE_JNDI_NAME);
            }

            private static QueueSession getQueueSession(Context context) throws JMSException, NamingException {
                QueueConnectionFactory cf = (QueueConnectionFactory) context
                        .lookup(QUEUE_FACTORY_JNDI_NAME);
                QueueConnection connection = cf.createQueueConnection();
                return (QueueSession) connection.createSession(false, 1);
            }
        }
~~~~

    3. Return to Overview in the Windup report.

## Step 4. Migrate `jee-example-webp`

1. Click the link for `Weblogic.xml`.

    1. Save the generated `jboss-web.xml` file to the `WEB-INF` folder of the web application.

    2. Review the conversion links and note that the migration requires changes in two files: `jboss-web.xml` and `standalone-full-windup.xml`.

2. Add the following to `jboss-web.xml`:
~~~~
    <?xml version="1.0" encoding="UTF-8"?>

    <jboss-web>

        <security-domain>java:/jaas/FormBasedAuthWebAppPolicy</security-domain>

        <context-root>jee-example-web</context-root>

    </jboss-web>
~~~~

3. Reopen `standalone-full-windup.xml` and add the following security domain:
~~~~
    <security-domain name="FormBasedAuthWebAppPolicy">
        <authentication>
            <login-module code="org.jboss.security.auth.spi.DatabaseServerLoginModule" flag="required">
                <module-option name="dsJndiName" value="java:jboss/datasources/ExampleDS"/>
                <module-option name="principalsQuery" value="select password from  PRINCIPLES where principal_id=?"/>
                <module-option name="rolesQuery" value="select user_role, 'Roles' from  ROLES where  principal_id=?"/>
            </login-module>
            <!-- Following is the RoleMappingLoginModule -->
            <login-module code="org.jboss.security.auth.spi.RoleMappingLoginModule" flag="optional">
                <module-option name="rolesProperties" value="/home/userone/jboss-eap-6.0-GA/standalone/configuration/test-roles.properties"/>
                <module-option name="replaceRole" value="false"/>
            </login-module>
        </authentication>
    </security-domain>
~~~~

4. Change the value for rolesProperties to the path that matches the path to the test-roles.properties file on your server.

5. Use the following content for the `test-roles.properties` file:
~~~~
WebRunAsRole=Admin
~~~~

## Step 5. Attempt to Build

The first attempt to build the project will fail, but you will fix the issues.

1. From the root of the project, run the following Maven build command:  

~~~~
mvn clean package
~~~~

{{% alert warning %}}
You get errors on LogEventSubscriber, ProductCatalogBean.java, ItemLookupBean.java, ProductCatalogBean.java, and ItemLooupBean.java.
{{% /alert %}}

## Step 6.Convert EJBs from EJB 2.1 to EJB 3.0

Convert `ItemLookupBean.java` to use EJB 3.0 standards.

1. Delete `com.acme.anvil.service.ItemLookupHome`.

2. Delete `com.acme.anvil.service.ItemLookupLocalHome`.

3. Change `com.acme.anvil.service.ItemLookup.java` to the following:
~~~~
    package com.acme.anvil.service;

    import com.acme.anvil.vo.Item;

    public interface ItemLookup {

        public Item lookupItem(long id);
    }
~~~~

4. Do the following to `ItemLookupLocal.java`:

    1. Add the `@Local` annotation.

    2. Remove `extends EJBLocalObject`.

    3. Have `@Local` extend `ItemLookup`.  `ItemLookupLocal.java` should look like the following:
~~~~
        package com.acme.anvil.service;

        import javax.ejb.Local;
        import com.acme.anvil.vo.Item;

        @Local
        public interface ItemLookupLocal extends ItemLookup {
        }
~~~~

5. Remove `GenericSessionBean` Reference from `ItemLookupBean.java` and add `import javax.ejb.Stateles`s.  `ItemLookupBean.java` should look like the following:
~~~~
    package com.acme.anvil.service;

    import java.util.Date;
    import javax.ejb.Stateless;
    import org.apache.log4j.Logger;
    import com.acme.anvil.service.jms.LogEventPublisher;
    import com.acme.anvil.vo.Item;
    import com.acme.anvil.vo.LogEvent;

    @Stateless
    public class ItemLookupBean implements ItemLookupLocal {

        private static final Logger LOG = Logger.getLogger(ItemLookupBean.class);

        public Item lookupItem(long id) {
            LOG.info("Calling lookupItem.");

            Item item = new Item();
            item.setId(id);

            final LogEvent le = new LogEvent(new Date(), "Returning Item: "+id);
            LogEventPublisher.publishLogEvent(le);

            return item;
        }
    }
~~~~

6. Make analogous changes to `ProductCatalogBean` and its supporting classes.

7. Convert `LogEventSubscriber` to a standard MDB format.  `LogEventSubScriber` should resemble the following:
~~~~
    package com.acme.anvil.service.jms;

    import java.text.SimpleDateFormat;
    import javax.ejb.MessageDriven;
    import javax.ejb.ActivationConfigProperty;
    import javax.jms.JMSException;
    import javax.jms.Message;
    import javax.jms.MessageListener;
    import javax.jms.ObjectMessage;

    import org.apache.log4j.Logger;
    import com.acme.anvil.vo.LogEvent;

    @MessageDriven(name = "LogEventSubscriber", activationConfig = {
    @ActivationConfigProperty(propertyName = "destinationType", propertyValue = "javax.jms.Queue"),
    @ActivationConfigProperty(propertyName = "destination", propertyValue = "jms/LogEventQueue"),
    @ActivationConfigProperty(propertyName = "acknowledgeMode", propertyValue = "Auto-acknowledge") })

    public class LogEventSubscriber implements MessageListener {

    private static final Logger LOG = Logger.getLogger(LogEventSubscriber.class);
    private static final SimpleDateFormat SDF = new SimpleDateFormat("MM/dd/yyyy 'at' HH:mm:ss z");

    public void onMessage(Message msg) {
           ObjectMessage om = (ObjectMessage)msg;
           Object obj;
           try {
                obj = om.getObject();

                if(obj instanceof LogEvent) {
                   LogEvent event = (LogEvent)obj;
                   LOG.info("Log Event ["+SDF.format(event.getDate())+"] : "+event.getMessage());
                }
           } catch (JMSException e) {
                LOG.error("Exception reading message.", e);
           }
        }
    }
~~~~

8. Convert `AnvilWebServlet` to use EJB 3.0 lookup semantics.  `AnvilWebServlet` should resemble the following:
~~~~
    package com.acme.anvil;

    import java.io.IOException;

    import javax.ejb.CreateException;
    import javax.ejb.EJBException;
    import javax.naming.InitialContext;
    import javax.naming.NamingException;
    import javax.servlet.ServletException;
    import javax.servlet.http.HttpServlet;
    import javax.servlet.http.HttpServletRequest;
    import javax.servlet.http.HttpServletResponse;

    import org.apache.commons.lang.StringUtils;
    import org.apache.log4j.Logger;

    import com.acme.anvil.service.ItemLookup;

    public class AnvilWebServlet extends HttpServlet {

       private static final Logger LOG = Logger.getLogger(AnvilWebServlet.class);

       @Override
       protected void doGet(HttpServletRequest req, HttpServletResponse resp) throws ServletException, IOException {

           InitialContext ic;
           ItemLookup local;
           try {
               ic = new InitialContext();
               local  = (ItemLookup)ic.lookup("ItemLookupBean/local");

               String itemId = req.getParameter("id");
               if(StringUtils.isNotBlank(itemId)) {
                   Long id = Long.parseLong(itemId);
                   local.lookupItem(id);
               }
           } catch (EJBException e) {
               LOG.error("Exception EJB.", e);
           } catch (NamingException e) {
               LOG.error("Exception looking up EJB LocalHome.", e);
           }

       }
    }
~~~~

9. Run `mvn clean package` to recompile the application.

## Step 7. Deploy the Application

Deploy the application to Red Hat JBoss Enterprise Application Platform 6 (JBoss EAP 6).

1. From the bin folder of $JBOSS_HOME, run the following command to start JBoss EAP 6 with the custom configuration file:
~~~~
    ./standalone.sh -c standalone-full-windup.xml
~~~~

2. Deploy with the copy command:
~~~~
    cp jee-example-app/target/sample-jee-weblogic-app-2.0.0-SNAPSHOT.ear $JBOSS_HOME/standalone/deployments/.
~~~~

# Conclusion
As demonstrated in this lab, you still have to do the work, but Windup provides guidance and assistance to help the migration go smoothly and predictably.

You may have noticed opportunities in the lab where Windup could have reported more information. In subsequent labs, you discover how to make Windup reports more helpful by adding to the rulebase.

