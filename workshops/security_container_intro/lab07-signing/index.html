<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Lab 7.0 - Container image signing | Red Hat | Public Sector</title>

    
    
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly.min.css" />
    <link rel="stylesheet" href="/node_modules/patternfly/dist/css/patternfly-additions.min.css" />

    
    <link rel="stylesheet" href="/node_modules/highlight.js/styles/darkula.css" />

    
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="stylesheet" href="/css/asciidoc.css" />
    <link rel="stylesheet" href="/css/custom.css" />
    <link rel="stylesheet" href="/css/toastr.min.css" />

    
    <script id="adobe_dtm" src="//www.redhat.com/dtm.js" type="text/javascript"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery/dist/jquery.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/c3/c3.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/d3/d3.min.js"></script>

    
    
    <script src="/node_modules/patternfly/node_modules/datatables/media/js/jquery.dataTables.min.js"></script>
    <script src="/node_modules/patternfly/node_modules/drmonty-datatables-colvis/js/dataTables.colVis.js"></script>
    <script src="/node_modules/patternfly/node_modules/datatables.net-colreorder/js/dataTables.colReorder.js"></script>

    
    
    <script src="/node_modules/patternfly/dist/js/patternfly.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-combobox/js/bootstrap-combobox.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/moment/min/moment.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/eonasdan-bootstrap-datetimepicker/build/js/bootstrap-datetimepicker.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-select/dist/js/bootstrap-select.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-switch/dist/js/bootstrap-switch.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/bootstrap-touchspin/dist/jquery.bootstrap-touchspin.min.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/patternfly-bootstrap-treeview/dist/bootstrap-treeview.min.js"></script>

    
    <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

    
    <script src="/node_modules/patternfly/node_modules/jquery-match-height/dist/jquery.matchHeight-min.js"></script>
    
    <script src="/js/clipboard.min.js"></script>
    <script src="/js/clip.js"></script>

    
    <script src="/js/toastr.min.js"></script>

    
    <script src="/node_modules/highlight.js/lib/highlight.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
  </head>
  <body class="">
    

<nav class="navbar navbar-default navbar-inverse navbar-fixed-top " role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">
      <svg width=150 height=auto id="Layer_1" data-name="Layer 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 613 145"><defs><style>.cls-1{fill:#e00;}.cls-2{fill:#fff;}</style></defs><path class="cls-1" d="M127.47,83.49c12.51,0,30.61-2.58,30.61-17.46a14,14,0,0,0-.31-3.42l-7.45-32.36c-1.72-7.12-3.23-10.35-15.73-16.6C124.89,8.69,103.76.5,97.51.5,91.69.5,90,8,83.06,8c-6.68,0-11.64-5.6-17.89-5.6-6,0-9.91,4.09-12.93,12.5,0,0-8.41,23.72-9.49,27.16A6.43,6.43,0,0,0,42.53,44c0,9.22,36.3,39.45,84.94,39.45M160,72.07c1.73,8.19,1.73,9.05,1.73,10.13,0,14-15.74,21.77-36.43,21.77C78.54,104,37.58,76.6,37.58,58.49a18.45,18.45,0,0,1,1.51-7.33C22.27,52,.5,55,.5,74.22c0,31.48,74.59,70.28,133.65,70.28,45.28,0,56.7-20.48,56.7-36.65,0-12.72-11-27.16-30.83-35.78"/><path d="M160,72.07c1.73,8.19,1.73,9.05,1.73,10.13,0,14-15.74,21.77-36.43,21.77C78.54,104,37.58,76.6,37.58,58.49a18.45,18.45,0,0,1,1.51-7.33l3.66-9.06A6.43,6.43,0,0,0,42.53,44c0,9.22,36.3,39.45,84.94,39.45,12.51,0,30.61-2.58,30.61-17.46a14,14,0,0,0-.31-3.42Z"/><path class="cls-2" d="M579.74,92.8c0,11.89,7.15,17.67,20.19,17.67a52.11,52.11,0,0,0,11.89-1.68V95a24.84,24.84,0,0,1-7.68,1.16c-5.37,0-7.36-1.68-7.36-6.73V68.3h15.56V54.1H596.78v-18l-17,3.68V54.1H568.49V68.3h11.25Zm-53,.32c0-3.68,3.69-5.47,9.26-5.47a43.12,43.12,0,0,1,10.1,1.26v7.15a21.51,21.51,0,0,1-10.63,2.63c-5.46,0-8.73-2.1-8.73-5.57m5.2,17.56c6,0,10.84-1.26,15.36-4.31v3.37h16.82V74.08c0-13.56-9.14-21-24.39-21-8.52,0-16.94,2-26,6.1l6.1,12.52c6.52-2.74,12-4.42,16.83-4.42,7,0,10.62,2.73,10.62,8.31v2.73a49.53,49.53,0,0,0-12.62-1.58c-14.31,0-22.93,6-22.93,16.73,0,9.78,7.78,17.24,20.19,17.24m-92.44-.94h18.09V80.92h30.29v28.82H506V36.12H487.93V64.41H457.64V36.12H439.55ZM370.62,81.87c0-8,6.31-14.1,14.62-14.1A17.22,17.22,0,0,1,397,72.09V91.54A16.36,16.36,0,0,1,385.24,96c-8.2,0-14.62-6.1-14.62-14.09m26.61,27.87h16.83V32.44l-17,3.68V57.05a28.3,28.3,0,0,0-14.2-3.68c-16.19,0-28.92,12.51-28.92,28.5a28.25,28.25,0,0,0,28.4,28.6,25.12,25.12,0,0,0,14.93-4.83ZM320,67c5.36,0,9.88,3.47,11.67,8.83H308.47C310.15,70.3,314.36,67,320,67M291.33,82c0,16.2,13.25,28.82,30.28,28.82,9.36,0,16.2-2.53,23.25-8.42l-11.26-10c-2.63,2.74-6.52,4.21-11.14,4.21a14.39,14.39,0,0,1-13.68-8.83h39.65V83.55c0-17.67-11.88-30.39-28.08-30.39a28.57,28.57,0,0,0-29,28.81M262,51.58c6,0,9.36,3.78,9.36,8.31S268,68.2,262,68.2H244.11V51.58Zm-36,58.16h18.09V82.92h13.77l13.89,26.82H292l-16.2-29.45a22.27,22.27,0,0,0,13.88-20.72c0-13.25-10.41-23.45-26-23.45H226Z"/></svg>
      </a>
    </div>
    <div class="collapse navbar-collapse navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        
        
          
            <li>
              <a href="/">Home</a>
            </li>
          
        
          
            <li>
              <a href="/about/">About</a>
            </li>
          
        
          
            <li>
              <a href="/contact/">Contact</a>
            </li>
          
        
          
            <li>
              <a href="https://www.redhat.com/en/events">Events</a>
            </li>
          
        
          
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Workshops <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                
                  <li>
                    <a href="/workshops/agile_integrations_ci/">Agile Integrations Workshop - Citizen Integrator</a>
                  </li>
                
                  <li>
                    <a href="/workshops/agile_integrations_dev/">Agile Integrations Workshop - Developer</a>
                  </li>
                
                  <li>
                    <a href="/workshops/ansible_automation/">Ansible Automation Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/ansible_tower_intro/">Ansible Tower - an Introduction</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_container_intro/">Container Security - A Practical Introduction</a>
                  </li>
                
                  <li>
                    <a href="/workshops/containers_101/">Containers 101 Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/secure_software_factory/">DevSecOps Workshop - Secure Software Factory</a>
                  </li>
                
                  <li>
                    <a href="/workshops/containers_the_hard_way/">Linux Containers the Hard Way</a>
                  </li>
                
                  <li>
                    <a href="/workshops/strangling_the_monolith/">Microservices Workshop - Strangling the Monolith</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_4_101/">OpenShift 4 101</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_4_101_dynatrace/">OpenShift 4 101 w/Dynatrace</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_serverless/">OpenShift Serverless</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_service_mesh/">OpenShift Service Mesh</a>
                  </li>
                
                  <li>
                    <a href="/workshops/rhel_8/">Red Hat Enterprise Linux 8</a>
                  </li>
                
                  <li>
                    <a href="/workshops/selinux_policy/">SELinux Policy Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_service_mesh_v1.0/">zOpenShift Service Mesh</a>
                  </li>
                
              </ul>
            </li>
          
        
          
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                alpha <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                
                  <li>
                    <a href="/workshops/alpha/ansible_with_rhocp_edge/">Applied Ansible Automation - Containerized Edge Workshop</a>
                  </li>
                
              </ul>
            </li>
          
        
          
            <li class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                Retired <b class="caret"></b>
              </a>
              <ul class="dropdown-menu">
                
                  <li>
                    <a href="/workshops/ansible_tower_azure/">Ansible Tower Workshop on Azure</a>
                  </li>
                
                  <li>
                    <a href="/workshops/cloudforms41/">CloudForms Workshops</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_containers/">Container Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/jdv_dev/">JBoss Data Virtualization Development</a>
                  </li>
                
                  <li>
                    <a href="/workshops/openshift_101_dcmetromap/">OpenShift 101 - DC Metro Map Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/security_openshift/">OpenShift Security Workshop</a>
                  </li>
                
                  <li>
                    <a href="/workshops/rhosp_101/">Red Hat OpenStack Platform 101</a>
                  </li>
                
                  <li>
                    <a href="/workshops/source_to_image/">Source to Image</a>
                  </li>
                
              </ul>
            </li>
          
        
      </ul>
    </div>
  </div>
</nav>



<div class="jumbotron jumbotron-page text-center">
  <h1>Lab 7.0 - Container image signing</h1>
</div>

<div class="container">
  <div class="row">
    <p class="text-center">
      
      <a href="/workshops/security_container_intro">Return to Workshop</a>
    </p>

    








<nav>
  <ul class="pager">
    
    
    <li class="previous">
      <a href="/workshops/security_container_intro/lab06-inspecting/">&larr; Previous: Lab 6.0 - Container inspection with Podman &amp; Skopeo</a>
    </li>
    
    
    
    
    <li class="next">
      <a href="/workshops/security_container_intro/lab08-builds/">Next: Lab 8.0 - Composing containers with Buildah &rarr;</a>
    </li>
    
    
  </ul>
</nav>

    <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_configuring_the_signature_claim_store">Configuring the signature claim store</a>
<ul class="sectlevel2">
<li><a href="#_generating_key_pairs">Generating key pairs</a></li>
<li><a href="#_working_with_trust_policies">Working with trust policies</a></li>
<li><a href="#_pulling_signed_images">Pulling signed images</a></li>
<li><a href="#_create_a_trust_policy_for_red_hat_images">Create a trust policy for Red Hat images.</a></li>
<li><a href="#_blocking_a_registry">Blocking a registry</a></li>
</ul>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this lab, you will use <code>podman</code> to sign container images and create trust policies to control access to registries.</p>
</div>
<div class="paragraph">
<p>To begin the image signing procedure, a signature claim is generated by encrypting a container image manifest using a private
gpg key. The signature claims are stored in a file system or web
server where they can be decrypted later and used to pull signed
images.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/workshops/security_container_intro/images/encrypt.png" alt="Image Encryption">
</div>
</div>
<div class="paragraph">
<p>The procedure is reversed when pulling signed images.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="/workshops/security_container_intro/images/decrypt.png" alt="Image Decryption">
</div>
</div>
<div class="sect1">
<h2 id="_configuring_the_signature_claim_store">Configuring the signature claim store</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On the bastion server, create a configuration for the <code>node1</code> registry.</p>
</div>
<div class="paragraph">
<p>Become root to do this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo -i</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the configuration for node1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF &gt; /etc/containers/registries.d/node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker:
  node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000:
    sigstore: file:///var/tmp/sigstore/node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>
    sigstore-staging: file:///var/tmp/sigstore/node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exit from the root shell.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Notice we are using the <code>/var/tmp/sigstore</code> directory to store signature claims. This allows the system administrator to configure the signature store for a given registry and allows rootless users to push and pull signed container images.</p>
</div>
<div class="paragraph">
<p>Create a directory for the signature claims for the node1 registry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir -p /usr/tmp/sigstore/node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_generating_key_pairs">Generating key pairs</h3>
<div class="paragraph">
<p>Generate the gpg key pair. You&#8217;ll be prompted to set a pass phrase. Set it to <code>1234567890</code> so you don&#8217;t forget. :)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">gpg2 --quick-gen-key --yes ec2-user</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now export the public key. You&#8217;ll need it later.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">mkdir /usr/tmp/keys
gpg2 --export ec2-user &gt; /usr/tmp/keys/gpg-pubkey.gpg</code></pre>
</div>
</div>
<div class="paragraph">
<p>Confirm you have a container image with the <strong>correct REPOSITORY and TAG</strong> as shown.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman tag registry.fedoraproject.org/fedora:latest node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora:latest
podman images</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>REPOSITORY                                          TAG      IMAGE ID       CREATED       SIZE
node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest   latest   a4a954bf99ed   2 weeks ago   184 MB</pre>
</div>
</div>
<div class="paragraph">
<p>Login to the registry, then sign and push the image. When <code>podman</code> signs the image it will prompt for the gpg key pass phrase you used to create the key pair. It then creates a signature claim.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman login --username=redhat --password=redhat node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Login Succeeded!</pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">podman push --sign-by ec2-user node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Getting image source signatures
Copying blob acc367faa01d done
Copying blob 2e7173fdd054 done
Copying blob 852626d9f911 done
Copying blob 680fa67a4ae7 done
Copying blob 58e73958f78a done
Copying config a4a954bf99 done
Writing manifest to image destination
Signing manifest
Storing signatures</pre>
</div>
</div>
<div class="paragraph">
<p>Confirm the signature claim was created.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">tree /var/tmp/sigstore</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>/var/tmp/sigstore
└── node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>
    └── fedora
        └── latest@sha256=f1b2dc7705f263e24b6cc0f925df2593e087bfbca5e36053a2868e0c2a190569
            └── signature-1

2 directories, 1 file</pre>
</div>
</div>
<div class="paragraph">
<p>Confirm the push succeeded.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">curl  --user redhat:redhat https://node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/v2/_catalog</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>{"repositories":["fedora/latest"]}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_working_with_trust_policies">Working with trust policies</h3>
<div class="paragraph">
<p>In this exercise you will configure the image trust policy so that it allows only signed images to be pulled from a trusted registry on node1.</p>
</div>
<div class="paragraph">
<p>Start by examining the current trust policy (which accepts anything) then create a default policy that rejects all image pulls.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman image trust show</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>default             insecureAcceptAnything</pre>
</div>
</div>
<div class="paragraph">
<p>Change the policy to reject by default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman image trust set -t reject default
podman image trust show</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>          insecureAcceptAnything
default   reject</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_pulling_signed_images">Pulling signed images</h3>
<div class="paragraph">
<p>Now we are ready to try an image pull. To make certain you are authenticated to the registry, login again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman login --username=redhat --password=redhat node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Login Succeeded!</pre>
</div>
</div>
<div class="paragraph">
<p>Now test that image pulls are rejected by default.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman pull node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Trying to pull https://node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest...
  Running image docker://node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest:latest is rejected by policy.
Error: error pulling image "node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest": unable to pull node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest: unable to pull image: Source image rejected: Running image docker://node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest:latest is rejected by policy.</pre>
</div>
</div>
<div class="paragraph">
<p>Set a trust policy for <code>node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span></code> using your exported public gpg key.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman image trust set --type signedBy --pubkeysfile /usr/tmp/keys/gpg-pubkey.gpg node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now examine the image trust again. It should show that any image pulls from <strong>node1.%guid%.internal</strong> must be signed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman image trust show</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>default                      reject
node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000   signedBy                 ec2-user   file:///var/tmp/sigstore/node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, try to pull the image from the trusted registry on <code>node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span></code> and it should succeed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman pull node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Trying to pull node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest...
Getting image source signatures
Checking if image destination supports signatures
Copying blob e9bd946da7a5 skipped: already exists
Copying blob a727de8a9a50 skipped: already exists
Copying blob 60832cdfaf75 skipped: already exists
Copying blob f304768caba3 skipped: already exists
Copying blob 103696e3c551 skipped: already exists
Copying config a4a954bf99 done
Writing manifest to image destination
Storing signatures</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_create_a_trust_policy_for_red_hat_images">Create a trust policy for Red Hat images.</h3>
<div class="paragraph">
<p>In this exercise, you will create a trust policy that allows only signed images to be pulled from Red Hat&#8217;s Container Catalog.</p>
</div>
<div class="paragraph">
<p>First, try a pull and it should fail because of the default policy.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman pull registry.access.redhat.com/ubi8/ubi</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Trying to pull registry.access.redhat.com/ubi8/ubi...
  Running image docker://registry.access.redhat.com/ubi8/ubi:latest is rejected by policy.
Error: error pulling image "registry.access.redhat.com/ubi8/ubi": unable to pull registry.access.redhat.com/ubi8/ubi: unable to pull image: Source image rejected: Running image docker://registry.access.redhat.com/ubi8/ubi:latest is rejected by policy.</pre>
</div>
</div>
<div class="paragraph">
<p>Configure the sigstore for the RedHat registry.</p>
</div>
<div class="paragraph">
<p>Become root to do this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo -i</code></pre>
</div>
</div>
<div class="paragraph">
<p>Create the configuration for node1.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">cat &lt;&lt;EOF &gt; /etc/containers/registries.d/registry.access.redhat.com.yaml</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">docker:
     registry.access.redhat.com:
         sigstore: https://access.redhat.com/webassets/docker/content/sigstore
EOF</code></pre>
</div>
</div>
<div class="paragraph">
<p>Exit from the root shell.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">exit</code></pre>
</div>
</div>
<div class="paragraph">
<p>Configure the trust policy for the RedHat registry.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">sudo podman image trust set -f /etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release registry.access.redhat.com</code></pre>
</div>
</div>
<div class="paragraph">
<p>Examine the trust policy again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman image trust show</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>default                              reject
registry.access.redhat.com           signedBy                security@redhat.com, security@redhat.com  https://access.redhat.com/webassets/docker/content/sigstore
node1-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000  signedBy                ec2-user                                  file:///var/tmp/sigstore/node1-0.jajcontainer.rhnaps.io
                                     insecureAcceptAnything</pre>
</div>
</div>
<div class="paragraph">
<p>Try the image pull again.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman pull registry.access.redhat.com/ubi8/ubi</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Trying to pull registry.access.redhat.com/ubi8/ubi...
Getting image source signatures
Checking if image destination supports signatures
Copying blob 0bb54aa5e977 done
Copying blob 941e1e2b31a8 done
Copying config 0c46e5c7a8 done
Writing manifest to image destination
Storing signatures
0c46e5c7a82a97d21447ee6a1ef0d407317642c9361b562456395e087be08774</pre>
</div>
</div>
<div class="paragraph">
<p>This <a href="https://access.redhat.com/articles/3116561">kbase article</a> has more detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="_blocking_a_registry">Blocking a registry</h3>
<div class="paragraph">
<p>It is recommended that a registry trust policy be used to control which registries you want to allow users to pull and push from. This gives greater flexibility, and supports all container runtimes and tools including the docker daemon, podman, buildah and cri-o.</p>
</div>
<div class="paragraph">
<p>There are a few ways to approach this:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Create a default reject policy and trust only node1</p>
</li>
<li>
<p>Create a default accept policy and reject node2</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Take what you&#8217;ve learned and give each a try.</p>
</div>
<div class="paragraph">
<p>Now try to pull the image from <code>node2-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span></code>, it should fail.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">podman pull node2-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest</code></pre>
</div>
</div>
<div class="literalblock">
<div class="content">
<pre>Trying to pull https://node2-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest...
  Running image docker://node2-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest:latest is rejected by policy.
Error: error pulling image "node2-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest": unable to pull node2-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest: unable to pull image: Source image rejected: Running image docker://node2-<span class="userid">0</span>.<span class="prefix">example</span>.<span class="domain">redhatgov.io</span>:5000/fedora/latest:latest is rejected by policy.</pre>
</div>
</div>
<div class="paragraph">
<style>

 
.modal {
  display: none;  
  position: fixed;  
  z-index: 1;  
  left: 0;
  top: 0;
  width: 100%;  
  height: 100%;  
  overflow: auto;  
  background-color: rgb(0,0,0);  
  background-color: rgba(0,0,0,0.4);  
  -webkit-animation-name: fadeIn;  
  -webkit-animation-duration: 0.4s;
  animation-name: fadeIn;
  animation-duration: 0.4s
}

 
.modal-content {
  position: fixed;
  bottom: 0;
  background-color: #fefefe;
  width: 100%;
  -webkit-animation-name: slideIn;
  -webkit-animation-duration: 0.4s;
  animation-name: slideIn;
  animation-duration: 0.4s
}

 
.close {
  color: white;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

.modal-header {
  padding: 2px 16px;
  background-color: #000000;
  color: white;
}

.modal-body {padding: 2px 16px;}

.modal-footer {
  padding: 2px 16px;
  background-color: #000000;
  color: white;
}

 
@-webkit-keyframes slideIn {
  from {bottom: -300px; opacity: 0}
  to {bottom: 0; opacity: 1}
}

@keyframes slideIn {
  from {bottom: -300px; opacity: 0}
  to {bottom: 0; opacity: 1}
}

@-webkit-keyframes fadeIn {
  from {opacity: 0}
  to {opacity: 1}
}

@keyframes fadeIn {
  from {opacity: 0}
  to {opacity: 1}
}
</style>

<div id="myModal" class="modal">

  
  <div class="modal-content">
    <div class="modal-header">
      <span class="close">&times;</span>
      <h3>Workshop Details</h3>
    </div>
    <div class="modal-body">
<div class="row">
  <div class="col-lg-4 col-md-5 col-sm-12" id="workshopFooterDetails">
    <table>
      <tr>
        <td class="text-right"><b>Domain</b></td>
        <td><span class="domain"></span></td>
        <td rowspan="3">
        <img src="https://marketing-outfit-prod-images.s3-us-west-2.amazonaws.com/f5445ae0c9ddafd5b2f1836854d7416a/Logo-RedHat-Email.png" alt="Red Hat Logo" />
        </td>
      </tr>
      <tr>
        <td class="text-right"><b>Workshop</b></td>
        <td><span class="prefix"></span></td>
      </tr>
      <tr>
        <td class="text-right"><b>Student ID</b></td>
        <td><span class="userid"></span></td>
      </tr>
    </table>
  </div>
  <div class="col-lg-8 col-md-7 col-sm-12">
    <form id="footerForm" onsubmit="return false;" class="row" style="padding: 1.75rem 0 0 0;">
      <div class="form-group col-sm-6 col-md-6 col-lg-2">
        <label for="userid">Student ID</label>
        <select id="userid" name="userid">
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          <option value="8">8</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="16">16</option>
          <option value="17">17</option>
          <option value="18">18</option>
          <option value="19">19</option>
          <option value="20">20</option>
          <option value="21">21</option>
          <option value="22">22</option>
          <option value="23">23</option>
          <option value="24">24</option>
          <option value="25">25</option>
          <option value="26">26</option>
          <option value="27">27</option>
          <option value="28">28</option>
          <option value="29">29</option>
          <option value="30">30</option>
          <option value="31">31</option>
          <option value="32">32</option>
          <option value="33">33</option>
          <option value="34">34</option>
          <option value="35">35</option>
          <option value="36">36</option>
          <option value="37">37</option>
          <option value="38">38</option>
          <option value="39">39</option>
          <option value="40">40</option>
          <option value="41">41</option>
          <option value="42">42</option>
          <option value="43">43</option>
          <option value="44">44</option>
          <option value="45">45</option>
          <option value="46">46</option>
          <option value="47">47</option>
          <option value="48">48</option>
          <option value="49">49</option>
          <option value="50">50</option>
          <option value="51">51</option>
          <option value="52">52</option>
          <option value="53">53</option>
          <option value="54">54</option>
          <option value="55">55</option>
          <option value="56">56</option>
          <option value="57">57</option>
          <option value="58">58</option>
          <option value="59">59</option>
          <option value="60">60</option>
          <option value="61">61</option>
          <option value="62">62</option>
          <option value="63">63</option>
          <option value="64">64</option>
          <option value="65">65</option>
          <option value="66">66</option>
          <option value="67">67</option>
          <option value="68">68</option>
          <option value="69">69</option>
          <option value="70">70</option>
          <option value="71">71</option>
          <option value="72">72</option>
          <option value="73">73</option>
          <option value="74">74</option>
          <option value="75">75</option>
          <option value="76">76</option>
          <option value="77">77</option>
          <option value="78">78</option>
          <option value="79">79</option>
          <option value="80">80</option>
          <option value="81">81</option>
          <option value="82">82</option>
          <option value="83">83</option>
          <option value="84">84</option>
          <option value="85">85</option>
          <option value="86">86</option>
          <option value="87">87</option>
          <option value="88">88</option>
          <option value="89">89</option>
          <option value="90">90</option>
          <option value="91">91</option>
          <option value="92">92</option>
          <option value="93">93</option>
          <option value="94">94</option>
          <option value="95">95</option>
          <option value="96">96</option>
          <option value="97">97</option>
          <option value="98">98</option>
          <option value="99">99</option>
          <option value="100">100</option>
          <option value="101">101</option>
          <option value="102">102</option>
          <option value="103">103</option>
          <option value="104">104</option>
          <option value="105">105</option>
          <option value="106">106</option>
          <option value="107">107</option>
          <option value="108">108</option>
          <option value="109">109</option>
          <option value="110">110</option>
          <option value="111">111</option>
          <option value="112">112</option>
          <option value="113">113</option>
          <option value="114">114</option>
          <option value="115">115</option>
          <option value="116">116</option>
          <option value="117">117</option>
          <option value="118">118</option>
          <option value="119">119</option>
          <option value="120">120</option>
          <option value="121">121</option>
          <option value="122">122</option>
          <option value="123">123</option>
          <option value="124">124</option>
          <option value="125">125</option>
          <option value="126">126</option>
          <option value="127">127</option>
          <option value="128">128</option>
          <option value="129">129</option>
          <option value="130">130</option>
          <option value="131">131</option>
          <option value="132">132</option>
          <option value="133">133</option>
          <option value="134">134</option>
          <option value="135">135</option>
          <option value="136">136</option>
          <option value="137">137</option>
          <option value="138">138</option>
          <option value="139">139</option>
          <option value="140">140</option>
          <option value="141">141</option>
          <option value="142">142</option>
          <option value="143">143</option>
          <option value="144">144</option>
          <option value="145">145</option>
          <option value="146">146</option>
          <option value="147">147</option>
          <option value="148">148</option>
          <option value="149">149</option>
          <option value="150">150</option>
          <option value="151">151</option>
          <option value="152">152</option>
          <option value="153">153</option>
          <option value="154">154</option>
          <option value="155">155</option>
          <option value="156">156</option>
          <option value="157">157</option>
          <option value="158">158</option>
          <option value="159">159</option>
          <option value="160">160</option>
          <option value="161">161</option>
          <option value="162">162</option>
          <option value="163">163</option>
          <option value="164">164</option>
          <option value="165">165</option>
          <option value="166">166</option>
          <option value="167">167</option>
          <option value="168">168</option>
          <option value="169">169</option>
          <option value="170">170</option>
          <option value="171">171</option>
          <option value="172">172</option>
          <option value="173">173</option>
          <option value="174">174</option>
          <option value="175">175</option>
          <option value="176">176</option>
          <option value="177">177</option>
          <option value="178">178</option>
          <option value="179">179</option>
          <option value="180">180</option>
          <option value="181">181</option>
          <option value="182">182</option>
          <option value="183">183</option>
          <option value="184">184</option>
          <option value="185">185</option>
          <option value="186">186</option>
          <option value="187">187</option>
          <option value="188">188</option>
          <option value="189">189</option>
          <option value="190">190</option>
          <option value="191">191</option>
          <option value="192">192</option>
          <option value="193">193</option>
          <option value="194">194</option>
          <option value="195">195</option>
          <option value="196">196</option>
          <option value="197">197</option>
          <option value="198">198</option>
          <option value="199">199</option>
          <option value="200">200</option>
        </select>
      </div>
      <div class="form-group col-sm-6 col-md-6 col-lg-4">
        <label for="domain">Domain</label>
        <select id="domain" name="domain">
          <option value="rhnaps.io">rhnaps.io</option>
          <option value="redhatgov.io">redhatgov.io</option>
          <option value="az.redhatgov.io">az.redhatgov.io</option>
          <option value="redhat-fierce.io">redhat-fierce.io</option>
          <option value="fiercesw.network">fiercesw.network</option>
          <option value="rhtps.io">rhtps.io</option>
          <option value="openshiftworkshop.com">openshiftworkshop.com</option>
          <option value="redhatpsmwsa.com">redhatpsmwsa.com</option>
          <option value="open.redhat.com">open.redhat.com</option>
          <option value="opentlc.com">opentlc.com</option>
          <option value="aroapp.io">aroapp.io</option>
          <option value="danclark.io">danclark.io</option>
        </select>
      </div>
      <div class="form-group col-sm-6 col-md-6 col-lg-3">
        <label for="prefix">Workshop</label>
        <input id="prefix" name="prefix" type="text" size="16" class="form-control" placeholder="example" onkeyup="this.value = this.value.toLowerCase();this.value = this.value.replace(/[^-.a-zA-Z0-9]/g, '');"/>
      </div>
      <div class="form-group col-sm-6 col-md-6 col-lg-3">
        <button type="submit" class="btn btn-primary form-control" style="margin-bottom:1rem;">Enter</button>
        <button type="reset" class="btn btn-default form-control">Default</button>
      </div>
    </form>
  </div>
</div>

    </div>
    <div class="modal-footer">
      <h3></h3>
    </div>
  </div>

</div>

<script type="text/javascript" src="/node_modules/js-cookie/src/js.cookie.js"></script>
<script type="text/javascript">
<!--
  
  var Cookies2 = Cookies.noConflict();

  var cookiePathArr = cleanArray(window.location.pathname.split('/'));
  var cookiePath = '/' + cookiePathArr[0] + '/' + cookiePathArr[1] + '/';

  function cleanArray(actual) {
    var newArray = new Array();
    for (var i = 0; i < actual.length; i++) {
      if (actual[i]) {
        newArray.push(actual[i]);
      }
    }
    return newArray;
  }
  function replaceClassText() {
    jQuery("span.domain").html(Cookies2.get("domain"));
    jQuery("span.userid").html(Cookies2.get("userid"));
    jQuery("span.prefix").html(Cookies2.get("prefix"));
  }
  function pageLoadWorkshopFooterTest() {
    
    if (Cookies2.get("domain") === undefined) {
      resetWorkshopFooter();
    }
    else {
      replaceClassText();
      setWorkshopFooterInputValues()
    }
  }
  function setWorkshopFooterData() {
    
    Cookies2.set("domain", jQuery("select#domain").val(), { path: cookiePath, expires: 7 } );
    Cookies2.set("prefix", jQuery("input#prefix").val().replace(/[^-.a-zA-Z0-9]/g, ''), { path: cookiePath, expires: 7 } );
    Cookies2.set("userid", jQuery("select#userid").val(), { path: cookiePath, expires: 7 } );
    replaceClassText();
    modal.style.display = "none";
  }
  function setWorkshopFooterInputValues() {
    jQuery("select#domain").val(Cookies2.get("domain"));
    jQuery("input#prefix").val(Cookies2.get("prefix"));
    jQuery("select#userid").val(Cookies2.get("userid"));
  }
  function resetWorkshopFooter() {
    
    jQuery("select#domain, select#userid").prop("selectedIndex", 0);
    jQuery("input#prefix").val(jQuery("input#prefix").attr('placeholder'));
    
    Cookies2.set("domain", jQuery("select#domain option").first().val(), { path: cookiePath, expires: 7 } ); 
    Cookies2.set("userid", jQuery("select#userid option").first().val(), { path: cookiePath, expires: 7 } ); 
    Cookies2.set("prefix", jQuery("input#prefix").val(), { path: cookiePath, expires: 7 } );
    
    
    replaceClassText();
  }




  function updateFooter(e){
    fieldName = '';

    switch(e.id) {
      case 'userid':
        fieldName = 'User Id';
        break;
      case 'domain':
        fieldName = 'Domain';
        break;
      case 'prefix':
        fieldName = 'Workshop';
        break;
      default:
        fieldName = 'unknown';
    }
    setWorkshopFooterData();
    toastr["success"](fieldName + " set to " + e.value);
  }

  jQuery(document).ready(function() {
    pageLoadWorkshopFooterTest();


    
    var input = document.getElementById("prefix");

    
    input.addEventListener("keyup", function(event) {
      
      if (event.keyCode === 13) {
        
        event.preventDefault();
        
        
        updateFooter(input);
      }
    });


    jQuery("form#footerForm").submit(function() {
      setWorkshopFooterData();
      return false; 
    });

    jQuery("form#footerForm").bind("reset", function() {
      resetWorkshopFooter();
      return true;
    });

    return false;
  });
-->
</script>

<hr>
<h3>Workshop Details</h3>
    <table>
      <tr>
        <td class="text-right"><b>Domain</b></td>
        <td><span class="domain"></span></td>
        <td rowspan="3">
          <img src="https://marketing-outfit-prod-images.s3-us-west-2.amazonaws.com/f5445ae0c9ddafd5b2f1836854d7416a/Logo-RedHat-Email.png" alt="Red Hat Logo" />
        </td>
      </tr>
      <tr>
        <td class="text-right"><b>Workshop</b></td>
        <td><span class="prefix"></span></td>
      </tr>
      <tr>
        <td class="text-right"><b>Student ID</b></td>
        <td><span class="userid"></span></td>
      </tr>
    </table>
<button id="myBtn">Configure Workshop</button>
<hr>

<script>

var modal = document.getElementById("myModal");


var btn = document.getElementById("myBtn");


var span = document.getElementsByClassName("close")[0];


btn.onclick = function() {
  modal.style.display = "block";
}


span.onclick = function() {
  modal.style.display = "none";
}


window.onclick = function(event) {
  if (event.target == modal) {
    modal.style.display = "none";
  }
}
</script>


</div>
</div>
</div>
</div>


    








<nav>
  <ul class="pager">
    
    
    <li class="previous">
      <a href="/workshops/security_container_intro/lab06-inspecting/">&larr; Previous: Lab 6.0 - Container inspection with Podman &amp; Skopeo</a>
    </li>
    
    
    
    
    <li class="next">
      <a href="/workshops/security_container_intro/lab08-builds/">Next: Lab 8.0 - Composing containers with Buildah &rarr;</a>
    </li>
    
    
  </ul>
</nav>

    <p class="text-center">
      
      <a href="/workshops/security_container_intro">Return to Workshop</a>
    </p>
  </div>
</div>

    <div id="page-footer" class="container">
      <p class="text-center">
        Copyright &copy; 2023 Red Hat, Inc.
      </p>
    </div>
    <script type="text/javascript">
      if (("undefined" !== typeof _satellite) && ("function" === typeof _satellite.pageBottom)) {
          _satellite.pageBottom();
      }
    </script>
  </body>
</html>
